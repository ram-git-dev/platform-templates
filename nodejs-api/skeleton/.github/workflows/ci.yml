name: CI/CD with Flux

on:
  push:
    branches: [main]

env:
  SERVICE_NAME: ${{ values.name }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Build Docker image
        run: docker build -t ${SERVICE_NAME}:${IMAGE_TAG} .
      
      - name: Scan image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${SERVICE_NAME}:${IMAGE_TAG}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      
      # In real setup, push to ECR/GCR/Docker Hub here
      
      # Update GitOps repo
      - name: Update GitOps Repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clone GitOps repo
          git clone https://github.com/<your-username>/gitops-manifests.git
          cd gitops-manifests
          
          # Update image tag in deployment
          sed -i "s|image: ${SERVICE_NAME}:.*|image: ${SERVICE_NAME}:${IMAGE_TAG}|" apps/${SERVICE_NAME}/deployment.yaml
          
          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add apps/${SERVICE_NAME}/deployment.yaml
          git commit -m "Update ${SERVICE_NAME} to ${IMAGE_TAG}"
          git push https://${GITHUB_TOKEN}@github.com/<your-username>/gitops-manifests.git main
      
      - name: Notify Flux to reconcile
        run: |
          echo "Flux will detect changes within 1 minute"
          echo "Or trigger manually with: flux reconcile kustomization ${SERVICE_NAME}"